<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flexible Joint PID</title>

    <!-- 3dr party imports -->
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- d3 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- my imports -->
    <link rel="stylesheet" href="sty_experiment.css">
    <script src="sim_experiment.js"></script>
    <script src="vis_experiment.js"></script>
</head>

<body>

    <div class="controls">
        <label for="simcontrols">Simulation controls:</label>
        <button type="button" onclick="baseSim.start()" name="simcontrols">Start</button>
        <button type="button" onclick="baseSim.stop()">Stop</button>
        <button type="button" onclick="reset()">Reset</button>
        <br>
        <label for="simSpeed">Simulation speed:</label><br>
        <small> Slow-Motion </small>
        <input type="range" name="simSpeed" min="1" max="100" value="100" class="slider" onchange="setRealTimeFactor(this.value)">
        <small> Real-Time </small>
        <br>
        <label for="Kp">Input Kp:</label>
        <input type="number" name="Kp" id="Kp" value="1" step=".1">
        <br>
        <label for="Ki">Input Ki:</label>
        <input type="number" name="Ki" id="Ki" value="0" step=".1">
        <br>
        <label for="Kd">Input Kd:</label>
        <input type="number" name="Kd" id="Kd" value="0" step=".1">
    </div>

    <div class="groot" id="groot" style="width: 800px;"></div>
    <a href="index.html">
        <button type="button">Back to overview</button>
    </a>

    <script>
        // create the figure
        let figure = d3subploter.createFigure('groot', 800, 600);

        // add a gray area
        // figure.d3.append("rect")
        //     .attr("x", 0)
        //     .attr("y", 0)
        //     .attr("width", "100%")
        //     .attr("height", "100%")
        //     .style("fill", "#eee")
        //     .style("stroke", "black")

        // call the visualization class
        let baseVis = new BaseVis(figure);
        const plotTime = 20; // in seconds
        baseVis.plotTime = plotTime;

        // call the simulation class
        let baseSim = new FlexJointPID();

        // connect the visualization to the simulation
        baseSim.plotFun = function(t, x, u, z, y, w) {
            // add the new datapoint to the data
            baseVis.data.push({
                t: t,
                u: u[0],
                headAngle: rad2deg(y[0]),
                armAngle: rad2deg(y[1]),
                refAngle: rad2deg(w[0]),
            });
            baseVis.update();
        };

        // reset both
        function reset() {
            baseVis.reset();
            baseSim.reset();
        }
        // slow-motion
        function setRealTimeFactor(input) {
            let minFactor = 0.1,
                maxFactor = 1;

            let scale = d3.scaleLinear().domain([1, 100]).range([minFactor, maxFactor]);
            let factor = scale(input);
            baseSim.simMulti = factor
            baseVis.plotTime = plotTime * factor;
        };
        baseSim.Kp = parseFloat($('#Kp').val());
        baseSim.Ki = parseFloat($('#Ki').val());
        baseSim.Kd = parseFloat($('#Kd').val());
        $('#Kp').on('change', function() {
            baseSim.Kp = parseFloat(this.value);
        });
        $('#Ki').on('change', function() {
            baseSim.Ki = parseFloat(this.value);
        });
        $('#Kd').on('change', function() {
            baseSim.Kd = parseFloat(this.value);
        });
    </script>

</body>

</html>